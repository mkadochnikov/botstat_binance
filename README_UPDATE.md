# Инструкция по запуску и использованию обновленной системы

## Обзор изменений

В репозитории botstat_binance были внесены следующие изменения:

1. Создана структура таблиц в PostgreSQL для хранения данных графиков и метрик
2. Реализован скрипт для периодического сбора и записи данных в базу
3. Модифицирован основной код для чтения данных из PostgreSQL вместо прямых API-запросов
4. Добавлены новые модули для работы с базой данных

Эти изменения позволяют избежать ошибок из-за одновременного получения большого объема данных от поставщиков при открытии страницы, так как все данные теперь предварительно сохраняются в базе данных.

## Структура базы данных

В схеме `all_futures` созданы следующие таблицы:

1. `market_history` - исторические данные о капитализации и объеме рынка
2. `coins_metrics` - текущие метрики по топ-монетам
3. `fear_greed_index` - данные индекса страха и жадности
4. `binance_atr` - данные ATR по всем символам и таймфреймам

## Новые файлы

1. `/app/utils/db/schema.sql` - SQL-скрипт для создания таблиц
2. `/app/utils/db/db_connector.py` - модуль для подключения к базе данных
3. `/app/data_fetcher_db.py` - модуль для получения данных из базы данных
4. `/app/pages/home_page_db.py` - модифицированная страница с поддержкой базы данных
5. `/app/streamlit_app_db.py` - модифицированное приложение с поддержкой базы данных
6. `/data_collector.py` - скрипт для периодического сбора и записи данных в базу

## Настройка и запуск

### 1. Настройка базы данных

База данных PostgreSQL уже настроена со следующими параметрами:
```
DB_HOST = "46.252.251.117"
DB_PORT = "4791"
DB_NAME = "postgres"
DB_USER = "postgres"
DB_PASSWORD = "mysecretpassword"
DB_SCHEMA = "all_futures"
```

### 2. Запуск скрипта сбора данных

Для первоначального заполнения базы данных и настройки периодического обновления запустите:

```bash
python3 data_collector.py
```

Этот скрипт:
- Создаст необходимые таблицы в схеме `all_futures`
- Соберет и запишет данные о рынке, топ-монетах и индексе страха и жадности
- Настроит периодическое обновление данных (каждые 15 минут для топ-монет, каждый час для рыночных данных)

Рекомендуется запустить этот скрипт в фоновом режиме или настроить его как системный сервис:

```bash
nohup python3 data_collector.py > data_collector.log 2>&1 &
```

### 3. Запуск приложения с поддержкой базы данных

Для запуска модифицированного приложения, использующего данные из базы:

```bash
cd app
streamlit run streamlit_app_db.py
```

Или используйте существующий скрипт запуска, указав новый файл приложения:

```bash
./run.sh app/streamlit_app_db.py
```

## Проверка работы

После запуска приложения убедитесь, что:
1. Все графики и метрики отображаются корректно
2. Страница загружается быстро, без задержек
3. В логах нет ошибок, связанных с получением данных

## Дополнительные возможности

### Ручное обновление данных

Для принудительного обновления данных в базе можно запустить:

```bash
python3 -c "from data_collector import update_all_data; update_all_data()"
```

### Мониторинг логов

Логи сбора данных сохраняются в файл `data_collector.log`.
Логи работы приложения с базой данных сохраняются в файлы `data_fetcher_db.log` и `home_page_db.log`.

## Возможные проблемы и их решение

1. **Ошибка подключения к базе данных**
   - Проверьте параметры подключения в файлах `app/utils/db/db_connector.py` и `data_collector.py`
   - Убедитесь, что PostgreSQL запущен и доступен по указанному адресу и порту

2. **Отсутствие данных в графиках**
   - Убедитесь, что скрипт `data_collector.py` успешно запущен и заполнил базу данных
   - Проверьте логи на наличие ошибок при сборе данных

3. **Ошибки при запуске приложения**
   - Убедитесь, что установлены все необходимые зависимости
   - Проверьте пути импорта в файлах приложения
