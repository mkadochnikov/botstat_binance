# Модифицированный Binance ATR Monitor

## Описание изменений

В соответствии с требованиями, была изменена логика работы приложения:

1. **Бэкенд**:
   - Теперь рассчитанные значения ATR записываются в таблицу `binance_atr` в схеме `crypto` базы данных PostgreSQL
   - Добавлены новые эндпоинты для работы с базой данных
   - Реализовано сохранение времени последнего обновления данных

2. **Фронтенд**:
   - Изменена логика получения данных (теперь из БД вместо прямого расчета)
   - Добавлено отображение времени последнего обновления данных
   - Обновлен интерфейс для работы с новой логикой

3. **Дополнительно**:
   - Создан отдельный скрипт `update_db.py` для периодического обновления данных в базе
   - Добавлены инструкции по запуску и использованию

## Структура базы данных

```sql
CREATE TABLE IF NOT EXISTS crypto.binance_atr (
    symbol VARCHAR(10) PRIMARY KEY,
    price DECIMAL(15, 5) NOT NULL,
    atr_1m DECIMAL(15, 5),
    hot_1m BOOLEAN,
    atr_3m DECIMAL(15, 5),
    hot_3m BOOLEAN,
    atr_5m DECIMAL(15, 5),
    hot_5m BOOLEAN,
    atr_15m DECIMAL(15, 5),
    hot_15m BOOLEAN,
    atr_1h DECIMAL(15, 5),
    hot_1h BOOLEAN,
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Инструкция по запуску

### Установка зависимостей

```bash
pip install -r app/requirements.txt
```

### Запуск бэкенда

```bash
cd app
python main.py
```

Бэкенд запустится на порту 8008.

### Запуск фронтенда

```bash
cd app
streamlit run streamlit_app.py
```

Фронтенд будет доступен по адресу http://localhost:8501.

### Обновление данных в базе

Есть два способа обновления данных в базе:

1. **Через веб-интерфейс**: Нажмите кнопку "Обновить данные в базе" в боковой панели.

2. **Через скрипт обновления**:
   - Для однократного обновления:
     ```bash
     python update_db.py --once
     ```
   - Для периодического обновления каждые 3 часа:
     ```bash
     python update_db.py
     ```
   - Для указания другого интервала (в секундах):
     ```bash
     python update_db.py --interval 7200  # Обновление каждые 2 часа
     ```

## Примечания

1. Для корректной работы необходим доступ к Binance API. Если доступ ограничен, может потребоваться использование VPN или прокси.

2. Параметры подключения к базе данных настроены в файле `app/utils/db/database.py`:
   ```python
   DB_HOST = "46.252.251.117"
   DB_PORT = "4791"
   DB_NAME = "postgres"
   DB_USER = "postgres"
   DB_PASSWORD = "mysecretpassword"
   DB_SCHEMA = "crypto"
   DB_TABLE = "binance_atr"
   ```

3. Если таблица не существует, она будет создана автоматически при первом запуске.

4. Время последнего обновления данных отображается на главной странице фронтенда.

## Изменённые файлы

1. `app/api/endpoints.py` - Добавлена логика работы с базой данных
2. `app/streamlit_app.py` - Изменена логика получения данных и интерфейс
3. `app/utils/db/database.py` - Новый модуль для работы с базой данных
4. `app/utils/db/__init__.py` - Инициализация модуля базы данных
5. `app/requirements.txt` - Добавлена зависимость psycopg2-binary
6. `update_db.py` - Новый скрипт для периодического обновления данных
